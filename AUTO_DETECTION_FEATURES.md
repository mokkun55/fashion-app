# 服の自動属性検出機能

## 概要

服を登録する際に、画像から色や形状を自動検出して、カテゴリやサブカテゴリ、色、サイズ感を自動判定する機能を実装しました。

## 実装した機能

### 1. 色検出機能
- **K-meansクラスタリング**を使用して画像の主要色を抽出
- **HSV色空間**での色判定により、以下の色を自動識別：
  - 黒、白、グレー
  - 赤、ピンク、オレンジ、黄色
  - 緑、青、紫
  - 茶色、ベージュ
- 各色の割合（%）も表示

### 2. 輪郭検出・形状分析
- **Cannyエッジ検出**で輪郭を抽出
- **アスペクト比**による形状判定
- **円形度**による形状の複雑さ判定
- 面積と周囲長の分析

### 3. サイズ感推定
- アスペクト比に基づく形状分類：
  - 横長（ボトムス向き）
  - 縦長（トップス向き）
  - 正方形に近い（判断困難）
- 面積比に基づくサイズ感：
  - 大きめ、普通、小さめ

### 4. カテゴリ自動推定
- 形状分析結果に基づくカテゴリ判定：
  - **トップス**: 縦長の形状
  - **ボトムス**: 横長の形状
- サブカテゴリの推定：
  - トップス: 半袖、長袖・薄手、長袖・厚手
  - ボトムス: 短め、長め

## 技術仕様

### 使用ライブラリ
- **OpenCV**: 画像処理、輪郭検出、色空間変換
- **scikit-learn**: K-meansクラスタリング
- **PIL**: 画像読み込み
- **numpy**: 数値計算

### データベース拡張
以下の新しいカラムを`clothing`テーブルに追加：
- `detected_colors`: 検出された色情報（JSON）
- `detected_category`: 自動検出されたカテゴリ
- `detected_subcategory`: 自動検出されたサブカテゴリ
- `detection_confidence`: 検出の信頼度（0.0-1.0）
- `shape_analysis`: 形状分析結果（JSON）
- `size_estimation`: サイズ推定結果（JSON）

## 使用方法

### 1. 服登録画面での自動検出
1. 服の写真をアップロード
2. 自動的に画像分析が実行される
3. 分析結果が表示される：
   - 検出された色とその割合
   - 推定カテゴリとサブカテゴリ
   - サイズ感
   - 分析信頼度
4. 「この結果を適用」ボタンでフォームに自動入力

### 2. API エンドポイント
- `POST /analyze-image`: 画像をアップロードして分析結果を取得

## 信頼度について

- **色検出**: 主要色が5%以上の場合に信頼度を計算
- **形状分析**: 輪郭面積が1000ピクセル以上の場合に高信頼度
- **全体信頼度**: 色検出と形状分析の信頼度の平均

## 制限事項

1. **画像品質**: 背景が複雑な場合、輪郭検出の精度が下がる可能性
2. **色判定**: 照明条件によって色の判定が変わる場合がある
3. **形状判定**: 服が畳まれている場合、正確な形状判定が困難
4. **カテゴリ推定**: アスペクト比が中間的な場合、判定が困難

## 今後の改善案

1. **背景除去**: 服の背景を自動除去して精度向上
2. **機械学習**: より多くの画像データで学習したモデルの導入
3. **複数アイテム検出**: 1枚の画像から複数の服を検出
4. **ブランド・スタイル判定**: 服のブランドやスタイルの自動判定

## ファイル構成

- `image_processor.py`: 画像処理のメインロジック
- `migrate_database.py`: データベースマイグレーションスクリプト
- `templates/closet_form.html`: 自動検出機能付きの服登録フォーム
- `app.py`: 自動検出APIエンドポイントの追加